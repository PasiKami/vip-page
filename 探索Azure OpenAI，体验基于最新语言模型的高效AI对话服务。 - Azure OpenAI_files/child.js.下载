//æ‚¨è‡ªå·±çš„jsä»£ç å†™åˆ°ä¸‹é¢

console.log("jquery !");

jQuery(document).ready(function ($) {
    // å¼ºåˆ¶ç”¨æˆ·ä½¿ç”¨æ‰‹æœºå·
    // $("#login-box > div > div > div > form > div.login-box-in > label:nth-child(3) > span > b").text("æ‰‹æœºå·");
    // $("#login-box > div > div > div > form > div.login-box-in > label:nth-child(3) > span > b").text("æ‰‹æœºå·ï¼ˆç”¨æˆ·åï¼‰");
    // $("#login-box > div > div > div > form > div.login-box-in > label:nth-child(3) > p:nth-child(3)").text("ç”¨äºç™»å½•åŠä¿æŠ¤æ‚¨çš„è´¦æˆ·å®‰å…¨");



    // é¡¶éƒ¨èœå•æ ä¿®æ”¹
    $("#page > div.site-header.mg-b.social-top.social-no-sub > div > div > div > div.header-banner-right > div.top-search.mobile-hidden > form").hide();
    $("#page > div.site-header.mg-b.social-top.social-no-sub > div > div > div > div.header-banner-right > div.header-user > div.change-theme > div.mobile-show").hide();
    $("#page > div.site-header.mg-b.social-top.social-no-sub > div > div > div > div.header-banner-right > div.header-user > div.change-theme > div.mobile-hidden.user-tips"
    ).hide();

    // ä¾§è¾¹æ 
    $("div.bar-item:contains('æœç´¢')").hide();
    $("#content > div.aside-container > div.aside-bar > div > div.gdd-quick-link-buy-vip > a > div > p").text("ä¼šå‘˜ä¸“å±æƒç›Š");
    $("#content > div.aside-container > div.aside-bar > div > div.gdd-quick-link-buy-vip > div > div > p.gdd-quick-link-buy-vip__popover--title").text("æ˜†ä»‘AIä¼šå‘˜");
    $("#content > div.aside-container > div.aside-bar > div > div.gdd-quick-link-buy-vip > div > div > p.gdd-quick-link-buy-vip__popover--desc").text("è§£é” 10+ é«˜çº§åŠŸèƒ½");
    $("#content > div.aside-container > div.aside-bar > div > div.gdd-quick-link-buy-vip > div > div > a > p").text("æŸ¥çœ‹è¯¦æƒ…");

    // æ‰‹æœºç«¯åº•éƒ¨èœå•æ 
    $("#mobile-footer-menu > div.mobile-footer-center").hide();

    // ä¸ªäººä¸­å¿ƒ
    $("p.b2-pd:contains('æè¿°ï¼š')").hide();
    $("p.b2-pd:contains('ç½‘å€ï¼š')").hide();
    $("p.b2-pd:contains('è®¤è¯ï¼š')").hide();

    $("li:has(div.edit-name:contains('ç½‘å€'))").hide();

    // ä¿®æ”¹ä¼šå‘˜å›¾æ ‡
    var element = $('#author > div.box.b2-radius.author-header > div.user-panel > div.user-panel-info > div:nth-child(1) > h1 > span.user-page-lv > span.lv-icon.user-vip[class*="b2-vip"] > b');
    var color = element.css("color");
    element.css({
        "background-color": color,
        color: "white",
        "border-radius": "5px",
        padding: "2px 6px",
        "font-weight": "bold",
    });

    // è®¡ç®—ç”¨æˆ·å‰©ä½™ä¼šå‘˜æ—¶é•¿
    function getRemainingDays(targetDateString) {
        // å°†ç»™å®šçš„æ—¥æœŸå­—ç¬¦ä¸²è½¬æ¢ä¸ºDateå¯¹è±¡
        let targetDate = new Date(targetDateString);
        // è·å–å½“å‰æ—¥æœŸ
        let currentDate = new Date();

        // è®¡ç®—ä¸¤ä¸ªæ—¥æœŸä¹‹é—´çš„æ¯«ç§’å·®
        let timeDifference = targetDate - currentDate;

        // å°†æ¯«ç§’å·®è½¬æ¢ä¸ºå¤©æ•°
        let daysDifference = Math.ceil(timeDifference / (1000 * 60 * 60 * 24));

        return daysDifference;
    }

    // æ ¹æ®ç”¨æˆ·ä¸åŒèº«ä»½åˆ‡æ¢é¡µé¢æ˜¾ç¤º
    function switchUserPage(user_status, user_info) {



        const text_choose_ai_tips = $('#choose-ai-tips > div > h2');
        // const selector_choose_ai_tips = '#choose-ai-tips > div > h2';
        // const selector_go_kunlun_plus = '#go-kunlun-plus > div > div > a';
        const button_go_kunlun_plus = $('#go-kunlun-plus > div > div > a');
        button_go_kunlun_plus.off('click');




        const button_go_kunlun_copilot = $('#go-kunlun-copilot > div > div > a');
        button_go_kunlun_copilot.off('click');
        // button_go_kunlun_copilot.text('ç«‹å³ä½¿ç”¨');
        button_go_kunlun_copilot.attr('href', 'https://chat.todaoke.com');
        button_go_kunlun_copilot.on('click', function (e) {
            // é˜»æ­¢æŒ‰é’®çš„é»˜è®¤è¡Œä¸ºï¼Œä¾‹å¦‚å¦‚æœå®ƒæ˜¯ä¸€ä¸ªé“¾æ¥åˆ™é˜»æ­¢å®ƒè·³è½¬
            // e.preventDefault();

            // æ˜¾ç¤ºæç¤ºä¿¡æ¯
            alert('ğŸ“¢æ˜†ä»‘AIé¢†èˆªç‰ˆä¸ç°æœ‰å¹³å°ä¸äº’é€šï¼Œå› æ­¤æ‚¨éœ€è¦é‡æ–°æ³¨å†Œè´¦æˆ·å¹¶ç™»å½•ã€‚\n\nç”±äºå½“å‰å¤„äºå¼€æ”¾æµ‹è¯•é˜¶æ®µï¼Œæ‰€ä»¥ä¸æ’é™¤å‡ºç°ä½¿ç”¨å¼‚å¸¸çš„æƒ…å†µï¼Œå¦‚æœä½¿ç”¨ä¸­å‡ºç°é—®é¢˜ï¼Œæ‚¨å¯ä»¥å‘åœ¨çº¿å®¢æœè¿›è¡Œåé¦ˆã€‚\n\nå¦‚æœæ‚¨å½“å‰ä¼šå‘˜å°šæœªè¿‡æœŸï¼Œå¯è”ç³»åœ¨çº¿å®¢æœå…è´¹é¢†å–ä¼šå‘˜å…¬æµ‹ä¸“å±ç¦åˆ©~~');
        });


        switch (user_status) {
            case 'no_login':  // ç”¨æˆ·æœªç™»å½•
                text_choose_ai_tips.text('æ‚¨å½“å‰å°šæœªç™»å½•ï¼Œä»…å¯ä½¿ç”¨æ˜†ä»‘AIå…è´¹ç‰ˆ');
                // button_go_kunlun_plus.off('click');
                // ä¸ºæŒ‰é’®ç»‘å®šæ–°çš„ç‚¹å‡»äº‹ä»¶å¤„ç†ç¨‹åº
                button_go_kunlun_plus.on('click', function (e) {
                    // é˜»æ­¢æŒ‰é’®çš„é»˜è®¤è¡Œä¸ºï¼Œä¾‹å¦‚å¦‚æœå®ƒæ˜¯ä¸€ä¸ªé“¾æ¥åˆ™é˜»æ­¢å®ƒè·³è½¬
                    // e.preventDefault();

                    // æ˜¾ç¤ºæç¤ºä¿¡æ¯
                    alert('æ˜†ä»‘AIå…¨èƒ½ç‰ˆä¸ºä¼šå‘˜ä¸“äº«æƒç›Šï¼Œæ‚¨å½“å‰å°šæœªç™»å½•ã€‚å¦‚æœæ‚¨å·²ç»æ˜¯æ˜†ä»‘AIä¼šå‘˜ç”¨æˆ·ï¼Œè¯·å…ˆç™»å½•æ‚¨çš„è´¦æˆ·ã€‚');
                });
                
                
                $('#kunlun-plus-container').text('æ˜†ä»‘AIå…¨èƒ½ç‰ˆä¸ºä¼šå‘˜ä¸“äº«æƒç›Šï¼Œæ‚¨å½“å‰å°šæœªç™»å½•ã€‚å¦‚æœæ‚¨å·²ç»æ˜¯æ˜†ä»‘AIä¼šå‘˜ç”¨æˆ·ï¼Œè¯·å…ˆç™»å½•æ‚¨çš„è´¦æˆ·ã€‚');


                break;
            case 'no_vip':  // ç”¨æˆ·ä¸æ˜¯vip
                text_choose_ai_tips.text('æ‚¨å½“å‰å°šæœªå¼€é€šä¼šå‘˜ï¼Œä»…å¯ä½¿ç”¨æ˜†ä»‘AIå…è´¹ç‰ˆ');
                // button_go_kunlun_plus.off('click');
                // ä¸ºæŒ‰é’®ç»‘å®šæ–°çš„ç‚¹å‡»äº‹ä»¶å¤„ç†ç¨‹åº
                button_go_kunlun_plus.on('click', function (e) {
                    // é˜»æ­¢æŒ‰é’®çš„é»˜è®¤è¡Œä¸ºï¼Œä¾‹å¦‚å¦‚æœå®ƒæ˜¯ä¸€ä¸ªé“¾æ¥åˆ™é˜»æ­¢å®ƒè·³è½¬
                    e.preventDefault();
                    // æ˜¾ç¤ºæç¤ºä¿¡æ¯
                    alert('æ˜†ä»‘AIå…¨èƒ½ç‰ˆä¸ºä¼šå‘˜ä¸“äº«æƒç›Šï¼Œæ‚¨å°šæœªå¼€é€šæ˜†ä»‘AIä¼šå‘˜æœåŠ¡ã€‚å¦‚æœæ‚¨å¸Œæœ›ä½¿ç”¨å½“å‰AIï¼Œè¯·å…ˆå‰å¾€ä¼šå‘˜ä¸­å¿ƒå¼€é€šä¼šå‘˜æœåŠ¡ã€‚');
                });
                
                
                $('#kunlun-plus-container').text('æ˜†ä»‘AIå…¨èƒ½ç‰ˆä¸ºä¼šå‘˜ä¸“äº«æƒç›Šï¼Œæ‚¨å°šæœªå¼€é€šæ˜†ä»‘AIä¼šå‘˜æœåŠ¡ã€‚å¦‚æœæ‚¨å¸Œæœ›ä½¿ç”¨å½“å‰AIï¼Œè¯·å…ˆå‰å¾€ä¼šå‘˜ä¸­å¿ƒå¼€é€šä¼šå‘˜æœåŠ¡ã€‚');



                break;
            case 'vip':  // ç”¨æˆ·æ˜¯vip
                text_choose_ai_tips.text(`å°Šæ•¬çš„æ˜†ä»‘AI${user_info.lv.vip.name}ï¼Œæ‚¨å·²è§£é”å…¨éƒ¨AIï¼Œå‰©ä½™ä¼šå‘˜æ—¶é•¿ï¼š${getRemainingDays(user_info.lv.vip.time)}å¤©`);
                button_go_kunlun_plus.text('ç«‹å³ä½¿ç”¨');
                button_go_kunlun_plus.attr('href', '/kunlun-plus');

                // ä¸ºä¼šå‘˜ç”¨æˆ·æ·»åŠ æ˜†ä»‘å…¨èƒ½ç‰ˆiframe
                // åˆ›å»ºä¸€ä¸ªiframeå…ƒç´ 
                const iframe = $('<iframe>', {
                    src: 'https://service-kunlun-plus.todaoke.com',
                    width: '100%',
                    height: '700px',
                    frameborder: '0',
                    scrolling: 'no'
                });

                // å°†iframeæ·»åŠ åˆ°idä¸ºkunlun-plus-containerçš„divå†…éƒ¨
                $('#kunlun-plus-container').empty();
                $('#kunlun-plus-container').append(iframe);

                break;
            case 'error':  // å‡ºç°é”™è¯¯
                $(selector_choose_ai_tips).text(`è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œè¯·ç¨åã€‚å¦‚æœæ‚¨é•¿æœŸé‡åˆ°æ­¤æç¤ºï¼Œè¯·å‘äººå·¥å®¢æœåé¦ˆ`);


                break;

            default:  // å…¶ä»–æƒ…å†µ
                break;
        };
    }

    // è·å–ç”¨æˆ·ä¼šå‘˜çŠ¶æ€
    function getCookie(name) {
        let value = "; " + document.cookie;
        let parts = value.split("; " + name + "=");
        if (parts.length === 2) {
            return parts.pop().split(";").shift();
        }
    }
    let b2_token = getCookie("b2_token");
    $.ajax({
        url: "/wp-json/b2/v1/getUserInfo",
        method: "POST",
        headers: {
            Authorization: "Bearer " + b2_token,
        },
        success: function (response) {
            if (response && response.user_data && response.user_data.lv && response.user_data.lv.vip) {
                if (response.user_data.lv.vip.hasOwnProperty('name')) { // æ£€æŸ¥nameå±æ€§æ˜¯å¦å­˜åœ¨
                    var vipName = response.user_data.lv.vip.name;

                    if (vipName) { // å¦‚æœnameæœ‰å€¼ï¼Œåˆ™ç”¨æˆ·æ˜¯VIP
                        switchUserPage('vip', response.user_data);
                        console.log("ç”¨æˆ·æ˜¯VIP: " + vipName);
                    } else { // å¦‚æœnameæ²¡æœ‰å€¼æˆ–ä¸ºç©ºï¼Œåˆ™ç”¨æˆ·ä¸æ˜¯VIP
                        switchUserPage('no_vip', response.user_data);
                        console.log("ç”¨æˆ·ä¸æ˜¯VIP");
                    }
                } else { // å¦‚æœnameå±æ€§ä¸å­˜åœ¨ï¼Œåˆ™ç”¨æˆ·ä¸æ˜¯VIP
                    switchUserPage('no_vip', response.user_data);
                    console.log("ç”¨æˆ·ä¸æ˜¯VIP");
                }
            } else { // å¦‚æœæ•°æ®ç»“æ„ä¸é¢„æœŸä¸ç¬¦ï¼Œåˆ™è¾“å‡ºé”™è¯¯ä¿¡æ¯
                switchUserPage('error');

                console.log("è·å–ç”¨æˆ·èº«ä»½ä¿¡æ¯å¤±è´¥");
            }

        },
        error: function (jqXHR, textStatus, errorThrown) {
            if (jqXHR.status == 403) {
                switchUserPage('no_login');
                console.log("ç”¨æˆ·æœªç™»å½•");
            } else {
                console.log("é”™è¯¯:", textStatus, errorThrown);
            }
        },
    });
});

